<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîß R√©parer Firebase - Doron</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f7;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #1d1d1f; margin-top: 0; }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 500;
    }
    .info { background: #e3f2fd; color: #1976d2; }
    .success { background: #e8f5e9; color: #388e3c; }
    .error { background: #ffebee; color: #d32f2f; }
    .warning { background: #fff3e0; color: #f57c00; }
    button {
      background: #007aff;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin: 10px 0;
    }
    button:hover { background: #0051d5; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .progress {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin: 15px 0;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #007aff, #00c6ff);
      width: 0%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .log {
      background: #1d1d1f;
      color: #00ff00;
      padding: 15px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      margin: 15px 0;
      white-space: pre-wrap;
    }
    .step {
      margin: 20px 0;
      padding: 15px;
      border-left: 4px solid #007aff;
      background: #f8f9fa;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß R√©paration Firebase - Produits</h1>

    <div class="status info">
      <strong>üìã Ce que ce script va faire:</strong><br>
      1. ‚ùå Supprimer tous les anciens produits (sans tags)<br>
      2. ‚úÖ Uploader 2201 nouveaux produits (avec tags, categories, popularity)<br>
      3. ‚úì V√©rifier que tout fonctionne
    </div>

    <div class="step">
      <h3>üì± Instructions</h3>
      <ol>
        <li>Clique sur le bouton ci-dessous</li>
        <li>Attends la fin du processus (2-5 minutes)</li>
        <li>V√©rifie que tous les produits sont bien upload√©s</li>
        <li>Relance ton app et profite des 2201 produits vari√©s!</li>
      </ol>
    </div>

    <button id="startBtn" onclick="startFix()">üöÄ D√©marrer la r√©paration</button>

    <div class="progress" id="progressContainer" style="display: none;">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div id="status"></div>

    <div class="log" id="log" style="display: none;"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, writeBatch, doc, deleteDoc, query, limit, getCountFromServer } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ‚ö†Ô∏è REMPLACE PAR TA CONFIG FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyDyB0T-GqFJMTb5v8V3vB38hQp7QvRJZFo",
      authDomain: "doron-c9816.firebaseapp.com",
      projectId: "doron-c9816",
      storageBucket: "doron-c9816.firebasestorage.app",
      messagingSenderId: "498756063291",
      appId: "1:498756063291:web:97e9b79b6e6e8e9a6e85fc",
      measurementId: "G-1WQNVJY9QK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let logDiv, statusDiv, progressBar, progressContainer, startBtn;

    window.onload = function() {
      logDiv = document.getElementById('log');
      statusDiv = document.getElementById('status');
      progressBar = document.getElementById('progressBar');
      progressContainer = document.getElementById('progressContainer');
      startBtn = document.getElementById('startBtn');
    };

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      logDiv.textContent += `[${timestamp}] ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function setStatus(message, type = 'info') {
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function setProgress(percent) {
      progressBar.style.width = percent + '%';
      progressBar.textContent = Math.round(percent) + '%';
    }

    window.startFix = async function() {
      startBtn.disabled = true;
      logDiv.style.display = 'block';
      progressContainer.style.display = 'block';
      logDiv.textContent = '';

      try {
        // √âTAPE 1: Supprimer les anciens produits
        addLog('üóëÔ∏è  √âTAPE 1: Suppression des anciens produits...');
        setStatus('üóëÔ∏è  Suppression des anciens produits...', 'warning');
        setProgress(0);

        let deletedCount = 0;
        let hasMore = true;
        let deleteIteration = 0;

        while (hasMore && deleteIteration < 50) { // Max 50 iterations (25000 produits)
          const q = query(collection(db, 'products'), limit(500));
          const snapshot = await getDocs(q);

          if (snapshot.empty) {
            hasMore = false;
            break;
          }

          addLog(`   Suppression de ${snapshot.size} produits...`);

          const batch = writeBatch(db);
          snapshot.docs.forEach((document) => {
            batch.delete(document.ref);
          });

          await batch.commit();
          deletedCount += snapshot.size;
          deleteIteration++;

          addLog(`   ‚úÖ ${deletedCount} produits supprim√©s`);
          setProgress(10 + (deleteIteration * 2)); // 10-20% pour la suppression
        }

        addLog(`\n‚úÖ Suppression termin√©e: ${deletedCount} produits supprim√©s\n`);

        // √âTAPE 2: Charger les nouveaux produits depuis assets
        addLog('üìñ √âTAPE 2: Chargement des nouveaux produits...');
        setStatus('üìñ Chargement des produits...', 'info');
        setProgress(25);

        const response = await fetch('./assets/jsons/fallback_products.json');
        if (!response.ok) {
          throw new Error('Impossible de charger fallback_products.json');
        }

        const products = await response.json();
        addLog(`‚úÖ ${products.length} produits charg√©s\n`);

        // V√©rifier la structure
        const sampleProduct = products[0];
        addLog('üìã Structure v√©rifi√©e:');
        addLog(`   - Champs: ${Object.keys(sampleProduct).join(', ')}`);
        addLog(`   - Tags: ${sampleProduct.tags ? sampleProduct.tags.length : 0} tags`);
        addLog(`   - Categories: ${sampleProduct.categories ? sampleProduct.categories.length : 0} categories`);

        if (!sampleProduct.tags || !sampleProduct.categories) {
          throw new Error('ERREUR: Les produits n\'ont pas de tags/categories!');
        }

        // √âTAPE 3: Upload par batch
        addLog('\nüì§ √âTAPE 3: Upload des nouveaux produits...');
        setStatus('üì§ Upload des produits avec tags...', 'info');

        const batchSize = 500;
        let uploadedCount = 0;
        const totalBatches = Math.ceil(products.length / batchSize);

        for (let i = 0; i < products.length; i += batchSize) {
          const batch = writeBatch(db);
          const endIndex = Math.min(i + batchSize, products.length);
          const currentBatch = products.slice(i, endIndex);
          const batchNum = Math.floor(i / batchSize) + 1;

          addLog(`üì¶ Batch ${batchNum}/${totalBatches}: Produits ${i + 1} √† ${endIndex}...`);

          for (const product of currentBatch) {
            const docRef = doc(db, 'products', product.id.toString());
            const data = { ...product };
            delete data.id;

            // Assurer que les arrays sont pr√©sents
            if (!data.tags) data.tags = [];
            if (!data.categories) data.categories = [];

            batch.set(docRef, data);
            uploadedCount++;
          }

          await batch.commit();
          addLog(`   ‚úÖ ${currentBatch.length} produits upload√©s`);

          // Mise √† jour de la progression (25% √† 90%)
          const progress = 25 + ((batchNum / totalBatches) * 65);
          setProgress(progress);
        }

        addLog(`\n‚úÖ Upload termin√©: ${uploadedCount} produits upload√©s\n`);

        // √âTAPE 4: V√©rification finale
        addLog('üîç √âTAPE 4: V√©rification finale...');
        setStatus('üîç V√©rification finale...', 'info');
        setProgress(95);

        const countSnapshot = await getCountFromServer(collection(db, 'products'));
        const totalProducts = countSnapshot.data().count;
        addLog(`‚úÖ Total produits dans Firebase: ${totalProducts}`);

        // V√©rifier un produit avec tags
        const verifyQuery = query(collection(db, 'products'), limit(1));
        const verifySnapshot = await getDocs(verifyQuery);

        if (!verifySnapshot.empty) {
          const sampleData = verifySnapshot.docs[0].data();
          addLog(`‚úÖ Tags pr√©sents: ${sampleData.tags ? '‚úì' : '‚úó'}`);
          addLog(`‚úÖ Categories pr√©sentes: ${sampleData.categories ? '‚úì' : '‚úó'}`);
          addLog(`‚úÖ Exemple tags: ${sampleData.tags ? sampleData.tags.slice(0, 5).join(', ') : 'N/A'}`);
        }

        setProgress(100);
        setStatus(`
          <strong>üéâ R√âPARATION TERMIN√âE!</strong><br><br>
          ‚úÖ ${totalProducts} produits correctement configur√©s<br>
          ‚úÖ Tous les produits ont des tags et categories<br>
          ‚úÖ Pr√™t pour une exp√©rience personnalis√©e!<br><br>
          üì± <strong>Relance ton app maintenant et profite des produits vari√©s!</strong>
        `, 'success');

        addLog('\nüéâ SUCC√àS! Tu peux maintenant relancer ton app.');

      } catch (error) {
        addLog(`\n‚ùå ERREUR: ${error.message}`);
        setStatus(`‚ùå Erreur: ${error.message}`, 'error');
        console.error('Error:', error);
        startBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
